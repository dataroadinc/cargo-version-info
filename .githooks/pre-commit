#!/bin/sh

# Check for nightly toolchain
if ! rustup run nightly rustc --version > /dev/null 2>&1; then
    echo "Error: Rust nightly toolchain is required but not installed."
    echo "Install with: rustup install nightly"
    exit 1
fi

# Check for Rust files in commit
RUST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$' || true)
if [ -z "$RUST_FILES" ]; then
    echo "No Rust files in this commit, skipping checks."
    exit 0
fi

echo "Rust files detected in commit, running checks..."
echo ""

# Run cargo fmt check on changed files only
echo "Running cargo +nightly fmt --check on changed files..."
# shellcheck disable=SC2086
cargo +nightly fmt -- --check $RUST_FILES || {
    echo ""
    echo "❌ Code formatting check failed!"
    echo "Please run 'cargo +nightly fmt' to format your code before committing."
    exit 1
}

echo "✅ Code formatting check passed"

# Run clippy on whole crate (clippy doesn't support individual files)
echo ""
echo "Running cargo +nightly clippy..."
cargo +nightly clippy --all-targets --all-features -- -D warnings -W missing-docs || {
    echo ""
    echo "❌ Clippy check failed!"
    echo "Please fix the clippy warnings before committing."
    exit 1
}

echo "✅ Clippy check passed"
echo ""
echo "All pre-commit checks passed! ✨"
